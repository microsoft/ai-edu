Copyright © Microsoft Corporation. All rights reserved.
  适用于[License](https://github.com/Microsoft/ai-edu/blob/master/LICENSE.md)版权许可

## 7.2 线性多分类原理

此原理对线性多分类和非线性多分类都适用。

### 7.2.1 多分类计算公式与过程

以具有两个特征值的三分类举例，可以扩展到更多的分类。

1. 线性计算

$$z_1 = x_1 w_{11} + x_2 w_{21} + b_1 \tag{1}$$
$$z_2 = x_1 w_{12} + x_2 w_{22} + b_2 \tag{2}$$
$$z_3 = x_1 w_{13} + x_2 w_{23} + b_3 \tag{3}$$

2. 分类计算

$$
a_1=\frac{e^{z_1}}{\sum_i e^{z_i}}=\frac{e^{z_1}}{e^{z_1}+e^{z_2}+e^{z_3}}  \tag{4}
$$
$$
a_2=\frac{e^{z_2}}{\sum_i e^{z_i}}=\frac{e^{z_2}}{e^{z_1}+e^{z_2}+e^{z_3}}  \tag{5}
$$
$$
a_3=\frac{e^{z_3}}{\sum_i e^{z_i}}=\frac{e^{z_3}}{e^{z_1}+e^{z_2}+e^{z_3}}  \tag{6}
$$

3. 损失函数计算

单样本时：

$$
loss(w,b)=-(y_1 \ln a_1 + y_2 \ln a_2 + y_3 \ln a_3)  \tag{7}
$$

批量样本时：

$$J(w,b) =- \sum_{i=1}^m \sum_{j=1}^n y_{ij} \log a_{ij} \tag{8}$$

m是样本数，n是类别数。在交叉熵函数一节有详细介绍。

假设：

### 7.2.2 数值计算举例

假设：

$$z=[z_1,z_2,z_3]=[3,1,-3]$$

则按公式4、5、6进行计算，可以得出输出的概率分布是：

$$a=[a_1,a_2,a_3]=[0.879,0.119,0.002]$$

如果标签值表明是此样本为第一类，即：

$$y=[1,0,0]$$

则损失函数为：

$$
loss=-(1 \times \ln 0.879 + 0 \times \ln 0.119 + 0 \times \ln 0.002)=0.123
$$

如果标签值表明是此样本为第二类，即：

$$y=[0,1,0]$$

则损失函数为：

$$
loss=-(0 \times \ln 0.879 + 1 \times \ln 0.119 + 0 \times \ln 0.002)=2.128
$$

可以看到Softmax的输出a值认为此样本属于第一类，所以当标签值确实为第一类时，误差为0.123；而当标签值为第二类时，误差为2.128。

### 7.2.3 多分类的几何原理

在前面的二分类原理中，我们用一条直线分开两个部分，很容易理解。多分类问题，貌似有很多种分法啊，如何下手呢？

<img src="..\Images\7\MultipleClassifierData.png">

#### 当样本属于第一类时

假设一共有三类，红色为1，绿色为2，蓝色为3，那么Softmax的形式应该是：

$$
a_j = \frac{e^{z_j}}{\sum\limits_{i=1}^3 e^{z_i}}=\frac{e^{z_j}}{e^{z_1}+e^{z_2}+^{z_3}}
$$

如果判定一个点属于第一类，则有：

$$a_1 > a_2 且 a_1 > a_3 \tag{9}$$

由于Softmax的特殊形式，分母都一样，所以只比较分子就行了。而分子是一个自然指数，输出值域大于零且单调递增，所以只比较指数就可以了，因此，公式9等同于下式：

$$z_1 > z_2 且 z_1 > z_3 \tag{10}$$

把z的公式1、2、3引入到10：

$$x_1 w_{11}  + x_2 w_{21}  + b1  > x_1 w_{12} + x_2 w_{22}  + b_2 \tag{11}$$
$$x_1 w_{11}  + x_2 w_{21} + b1  > x_1 w_{13} + x_2 w_{23} + b_3 \tag{12}$$

变形：

$$(w_{21} - w_{22})x_2 > (w_{12} - w_{11})x_1 + (b_2 - b_1) \tag{13}$$

$$(w_{21} - w_{23})x_2 > (w_{13} - w_{11})x_1 + (b_3 - b_1) \tag{14}$$

我们先假设：

$$w_{21} > w_{22} > w_{23} \tag{15}$$

所以公式13，14左侧的系数都大于零，两边同时除以系数：

$$x_2 > {w_{12} - w_{11} \over w_{21} - w_{22}}x_1 + {b_2 - b_1 \over w_{21} - w_{22}} \tag{16}$$

$$x_2 > {w_{13} - w_{11} \over w_{21} - w_{23}} x_1 + {b_3 - b_1 \over w_{21} - w_{23}} \tag{17}$$

简化：

$$y > W_{12} \cdot x + B_{12} \tag{18}$$

$$y > W_{13} \cdot x + B_{13} \tag{19}$$

此时y代表了第一类的红色点。

借用二分类中的概念，公式18的几何含义是：有一条直线可以分开第一类（红色点）和第二类（绿色点），使得所有红色点都在直线的上方，所有的绿色点都在直线的下方。于是我们可以画出下图中的那条蓝色直线的分割作用。

而公式19的几何含义是：有一条直线可以分开第一类（红色点）和第三类（蓝色点），使得所有红色点都在直线的上方，所有的蓝色点都在直线的下方。于是我们可以画出下图中的那条绿色直线的分割作用。


也就是说在图中画两条直线，所有红点都同时在蓝线1和绿线2这两条直线的上方，如下图所示：

<img src="..\Images\7\z1z2z3.png">

同理，可以得到以下两种情况的直线：

#### 当样本属于第二类时

$$z_2 > z_1 且 z_2 > z_3$$

则：

$$x_1 w_{12}  + x_2 w_{22}  + b_2  > x_1 w_{11} + x_2 w_{21}  + b_1 \tag{20}$$
$$x_1 w_{12}  + x_2 w_{22} + b_1  > x_1 w_{13} + x_2 w_{23} + b_3 \tag{22}$$

仍然用公式15的假设：
$$w_{21} > w_{22} > w_{23} \tag{15}$$

两边除以相同的系数后，不等号会有变化：

$$x_2 < {w_{11} - w_{12} \over w_{22} - w_{21}}x_1 + {b_1 - b_2 \over w_{22} - w_{21}} \tag{23}$$

$$x_2 > {w_{13} - w_{12} \over w_{22} - w_{23}} x_1 + {b_3 - b_2 \over w_{22} - w_{23}} \tag{24}$$

由于：

$${w_{11} - w_{12} \over w_{22} - w_{21}} = {w_{12} - w_{11} \over w_{21} - w_{22}}
$$
$${b_2 - b_1 \over w_{21} - w_{22}}={b_1 - b_2 \over w_{22} - w_{21}}$$

所以：

$$y < W_{12} \cdot x + B_{12} \tag{25}$$

$$y > W_{23} \cdot x + B_{23} \tag{26}$$

此时y代表了第二类的绿色点。

公式25和公式18几何含义相同，不等号相反，代表了下图中蓝色直线的分割作用。

公式26的几何含义是，有一条直线可以分开第二类（绿色点）和第三类（蓝色点），使得所有绿色点都在直线的上方，所有的蓝色点都在直线的下方。于是我们可以画出下图中的那条红色直线的分割作用。

<img src="..\Images\7\z2z1z3.png">

#### 当样本属于第三类时

$$z_3 > z_1 且 z_3 > z_3$$

最后可得：

$$y < W_{13} \cdot x + B_{13} \tag{27}$$

$$y < W_{23} \cdot x + B_{23} \tag{28}$$

此时y代表了第三类的蓝色点。

公式27与公式19不等号相反，几何含义相同，代表了下图中绿色直线的分割作用。

公式28与公式26不等号相反，几何含义相同，代表了下图中红色直线的分割作用。


<img src="..\Images\7\z3z2z1.png">


把三张图综合在一起，应该是这个样子：

<img src="..\Images\7\z123.png">


### 思考与练习

1. 我们假设$w_{21} > w_{22} > w_{23}$是否有根据呢？假设$w_{21} > w_{23} > w_{23}$，直线的位置会有所变化吗？
