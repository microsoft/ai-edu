<!--Copyright © Microsoft Corporation. All rights reserved.
  适用于[License](https://github.com/Microsoft/ai-edu/blob/master/LICENSE.md)版权许可-->

## 最大似然估计

### 概率和统计的区别

概率（Probability）是已知模型和参数，用来预测结果数据。

像前面的例子中，我们已知黑白球的比例（参数）和抽取方法（模型），来预测抽到的球的颜色（结果数据）。

统计（Statistics）是已知数据，设定模型并反推参数。

在反推参数的过程中，由于采样数据本身的限制原因，参数的值有多种可能性，我们只能按照可能性最大的那种来估计形成给定样本的参数值，所以被称为最大似然估计。

关于似然函数的记法有很多，比如$P(x|\theta), L(\theta|x), L(x;\theta), f(x;\theta)$等，要根据上下文来判断它到底代表什么，很糟糕。所以在这里我们统一定义：
- $P(x|\theta)$ 表示概率；
- $L(x;\theta)$ 表示似然函数，不使用$L(\theta|x)$的记法；
- $f(x;\theta)$ 表示概率密度分布函数。

### 最大似然估计

问题1：一个袋子中有10个球，有黑白两种颜色，每次拿出一个记录颜色并放回，重复10次，查看记录得知取到白球7次，请问袋中白球的比例？

这显然是与前面的概率问题相反的问题。从前面的概率问题中，我们知道即使白黑比例为6:4，10次抽取后也只有0.250823的概率得到6次白球，还有0.214991的概率可以抽到7次白球。那么反过来，如果抽到7次白球，同样不能100%地认为白球占比就是0.7，也有可能是0.6、0.8等数值。

与上一节中的概率问题比较：
- 试验模型：一个袋子中有10个球，有黑白两种颜色，每次拿出一个记录颜色并放回，重复10次；
- 试验数据：取到白球7次；
- 反推参数：问袋中白球的比例。

由于问题比较简单，我们可以遍历所有白球占比的可能性，即$\theta=[0,0.1,0.2,...,1]$，然后根据公式1依次计算$P(x|\theta)$值：

$$
P(x|\theta) = C_n^x \theta^x (1-\theta)^{n-x} \tag{1}
$$

结果：
```
0.0 : 0.000000
0.1 : 0.000009
0.2 : 0.000786
0.3 : 0.009002
0.4 : 0.042467
0.5 : 0.117188
0.6 : 0.214991
0.7 : 0.266828
0.8 : 0.201327
0.9 : 0.057396
1.0 : 0.000000
```

<img src="Images/likelihood_berno.png"/>

图1

可以看到白球占比为0.7的可能性最大，最大似然值为0.266828。但是我们不能说白球的占比一定会是0.7，这就是已知试验数据反推参数，也就是**最大似然估计**（MLE - Maximum Likelihood Estimation）。

请注意，我们并不关心 $L$ 值到底是多少，只取最大值即可，所以在图中的标记点显示的是横坐标，下同。

### 单参数似然函数

上面我们用了遍历的笨办法，那么严格的数学方法如何解决问题1呢？

每种分布都有自己的概率密度函数公式，假设为$f$，则取一次球的概率为:
$$P(x_1;\theta)=f(x_1;\theta)$$

取两次球的概率为：

$$P(x_1,x_2;\theta)=f(x_1;\theta) \times f(x_2;\theta)$$

我们令这种已知 $x$ 求 $\theta$ 的情况为似然函数 $L$，代表$L$ikelihood。

则一般性的似然函数公式为：

$$
L(X;\theta) = L(x_1,...,x_n;\theta) = \prod_{i=1}^n f(x_i;\theta) \tag{2}
$$

也就是多个样本的概率的乘积。根据上一节的公式6把$f(k;\theta)$代入公式3中，写出问题1的似然公式：

$$
L(X;\theta)= \theta^7 (1-\theta)^{10-7} \tag{3}
$$

从图2中可以看出，公式的函数值 $L$ 有一个最大值，设其对应的 $\theta$ 值为 $\theta_{max}$。如何得到这个值呢？我们只需要对 $L$ 求导，再令导数为 0 就可以了。

$$
dL/d\theta=7\theta^6 (1-\theta)^3 - 3\theta^7(1-\theta)^2=0
$$
$$
7\theta^6 (1-\theta)^3 = 3\theta^7(1-\theta)^2
$$
$$
\theta_{max}=0.7
$$

结果和遍历方法的结论一致。

### 复杂分布的似然函数

上面的例子中是伯努利分布，比较简单，我们来看看稍微复杂一些的指数分布的似然函数形态。

$$
f(x;\theta)=\begin{cases} \frac{1}{\theta}e^{-x/\theta} & x>0 \\ 0 & other  \end{cases} \tag{4}
$$

概率密度分布函数要复杂一些，似然函数如下：

$$
L(x_1,...,x_n;\theta) = \prod_{i=1}^n \frac{1}{\theta}e^{-x_i/\theta} = \frac{1}{\theta^n} e^{-1/\theta \sum_{i=1}^n x_i} \tag{5}
$$

对公式5求导的话有些复杂，由于$L>0$，我们给等式两边取自然对数：

$$
\ln L = -n \ln \theta - \frac{1}{\theta}\sum_{i=1}^n x_i \tag{6}
$$

对公式6求导，并令结果为0，以便得到最大值解：

$$
\frac{d \ln L}{d\theta} = -\frac{n}{\theta} + \frac{1}{\theta^2}\sum_{i=1}^n x_i = 0 \tag{7}
$$

$$
\theta_{max} = \frac{1}{n}\sum_{i=1}^n x_i = \bar{x} \tag{8}
$$

公式8告诉我们，对于指数分布的参数 $\theta$ 的最大似然值等于 $x$ 的均值。

<img src="Images/likelihood_exp.png"/>
图2

图2中，分别设置$\theta$为0.5和0.3，用公式4得到两组指数分布样本数据$X1，X2$和它们的均值X1.mean和X2.mean，如下：
```
X1:
[2.         1.60147481 1.28236078 1.02683424 0.82222458 0.65838598
 0.52719428 0.42214418 0.33802663 0.27067057]
X1.mean:
0.8949316026487887

X2:
[3.33333333 2.30159517 1.5892021  1.09730996 0.75766899 0.52315419
 0.36122674 0.24941932 0.17221869 0.11891331]
X2.mean:
1.0504041796212955
```
然后令$\theta$值从0到3遍历，绘制出两条似然函数曲线，可以看到函数最大值所在横坐标与两组样本的均值相等，证明了公式8的正确性。

### 多参数似然函数

上面的例子中都只有一个参数 $\theta$，下面我们以正态分布为例，看看两个参数的似然函数形态。

$$
f(x;\theta_1,\theta_2)=f(x;\mu,\sigma) = \frac{1}{\sigma\sqrt{2\pi}}e^{-\frac{(x-\mu)^2}{2\sigma^2}} \tag{9}
$$

在这里，我们把两个参数实例化为$\mu,\sigma$，似然函数为：

$$
\begin{aligned}
L(x_1,...,x_n;\mu,\sigma)&=\prod^n_{i=1} \frac{1}{\sigma\sqrt{2\pi}}e^{-\frac{(x_i-\mu)^2}{2\sigma^2}}
\\
&=(\frac{1}{\sigma\sqrt{2\pi}})^n e^{-\frac{1}{2\sigma^2}\sum_{i=1}^n(x_i-\mu)^2}
\end{aligned} \tag{10}
$$

取对数：

$$
\ln L = n\ln\frac{1}{\sqrt{2\pi}} - \frac{n}{2}\ln \sigma^2-\frac{1}{2\sigma^2}\sum_{i=1}^n(x_i-\mu)^2 \tag{11}
$$

由于有两个参数，所以需要分别对它们求偏导，并令结果为0，得到方程组12：

$$
\begin{aligned}
\frac{\partial \ln L}{\partial \mu}&=\frac{1}{\sigma^2}\sum_{i=1}^n(x_i-\mu) = 0 
\\
\frac{\partial \ln L}{\partial \sigma^2}&=-\frac{n}{2\sigma^2}+\frac{1}{2\sigma^4}\sum_{i=1}^n(x_i-\mu)^2=0 
\end{aligned} \tag{12}
$$

解方程组12，得到：

$$
\begin{aligned}
\mu_{max} &= \frac{1}{n}\sum_{i=1}^nx_i = \bar{x}
\\ 
\sigma^2_{max} &= \frac{1}{n}\sum_{i=1}^n(x_i-\mu_{max})^2=\frac{1}{n}\sum_{i=1}^n(x_i-\bar{x})^2
\end{aligned} \tag{13}
$$

图3展示了两条关于 $\mu_{max}$ 的似然函数曲线：
1. 首先生成两组符合正态分布的随机数$X1，X2$，它们的真实均值分别为$\mu_{1}=0.386883$ 和 $\mu_{2}=0.575975$；
2. 然后根据公式10，在[0,1]区间以0.01的步长遍历作为 $\mu$ 值，计算每个点的 $L$ 值，得到两条似然曲线；
3. 可以看到实线曲线的最大似然值的横坐标在0.38左右，与$\mu_1$相同；虚线曲线的最大似然值的横坐标在0.57左右，与$\mu_2$相同；证明了公式13中关于$\mu_{max}$的估计是正确的。

<img src="Images/likelihood_norm_mu.png"/>

图3

图4展示了两条关于 $\sigma^2_{max}$ 的似然函数曲线：
1. 首先生成两组符合正态分布的随机数$X1，X2$，它们的真实均方差分别为$\sigma^2_{1}=0.243980$ 和 $\sigma^2_{2}=0.309661$；
2. 然后根据公式10，在[0,1]区间以0.01的步长遍历作为 $\sigma^2$ 值，计算每个点的 $L$ 值，得到两条似然曲线。
3. 可以看到实线曲线的最大似然值的横坐标在0.24左右，与$\sigma^2_1$相同；虚线曲线的最大似然值的横坐标在0.31左右，与$\sigma^2_2$相同；证明了公式13中关于$\sigma^2_{max}$的估计是正确的。

<img src="Images/likelihood_norm_std.png"/>

图4

综上所述，可得求解最大似然估计的一般过程为：

1. 写出似然函数；
2. 如果无法直接求导的话，对似然函数取对数；
3. 求导数；
4. 求解模型中参数的最优值。

