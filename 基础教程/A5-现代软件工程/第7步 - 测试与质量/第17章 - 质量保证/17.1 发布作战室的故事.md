## 17.1 发版“作战室”的故事

发版“作战室”，也就是Shiproom，在微软指软件发布的决策会议，主要产品经理或项目经理，研发负责人、功能负责人，一起探讨当前周期结束后，基于目标版本代码“快照”构建出的软件产品，是否符合预期和可以通过质量评估，进一步上线发布。该会议具有很重要的“战略意义”，所以笔者将Shiproom翻译成“作战室”。

### 17.1.1 “作战”会议上的讨论

近来，木头在团队里承担了一项新角色，由于他对团队产品代码和开发协作的方方面面都沉淀了很多经验，领导推荐木头担任产品的发版主持人，英文叫Shiproom Owner，相当于这个作战室的指挥官或者核心参谋的角色。
今天上午9点55分，木头提前来到会议室，打开会议大屏幕，将产品上线进度仪表盘投影到屏幕上，为这次的Shiproom会议做准备。目前团队的产品是双周上线一个包含新功能“大版本”，包含修复的“小版本”采用灵活上线的策略，质量达标就可以随时上，所以这个会议每周三次，没有版本变得的时候后就跳过。不一会儿，产品经理兼项目经理大刘（TPM，Technical Programme Manager），新功能负责人小李，工程质量负责人小陈，项目研发经理老付，陆陆续续来齐聚会议室。
木头：“大家上午好，目前各位可以看到仪表盘上显示，咱们有4个版本在不同的环境运行，V1.2.2在内部自测环境上线到百分之20%，V1.1.15目前在Alpha环境全量上线，V1.1.14在Beta环境上触及到30%的用户，生产环境上全量是V1.0.9。” 木头开始引导会议。
木头：“小李，请你先来介绍一下V1.2.2的新特性吧。”木头看向了新功能负责人小李。
小李：我们添加了一些用户体验的优化措施，并增强了一些功能模块，另外有一位研发同学帮忙优化了软件的CPU占用。
木头点点头，又看向了小陈：小陈，你可以给我们汇报一下，这些版本的综合质量情况吗？
小陈：对于V1.2.2，我们已经完成了大部分的自动化的功能和性能测试，但是我们在一项功能中发现了一个比较严重的bug，我们看到有一定的几率，大概每3到4次性能测试中，有一次能触发应用在这个新功能方面的OOM。
小陈提到的OOM是指Out Of Memory，即软件的内存使用超出了软件运行环境的内存使用上限。
木头皱了皱眉头：嗯，这个问题挺严重。小陈的建议是什么？
小陈：我建议我们内部自测环境先回滚一个更健康的版本上，这个环境下也有300多个用户。然后我们可以把修复bug的任务优先级提高，尽快修复。
木头点了点头：好，这个bug貌似在仪表盘上显示出来了，但是还没有在最高的优先级。
木头又看了一眼旁边大屏幕上的上线仪表，由于这个bug目前定的是P2，所以没有影响这个版本的健康状态，仪表盘上还是“形势一片大好”的绿意盎然（绿色代表版本质量状况是“健康”）。
木头：可能百分之30左右的复现概率有点高，老付，你对这个bug有什么看法？
老付沉思了一会儿，说：这个bug会前小陈发出来了，我们有在看，之前版本没见过这个问题，所以还真的是有可能是一个regression。目前还没有最终的原因分析结论，但是我觉得调高这个bug的优先级没问题，先定为P0的问题吧，不修复没法继续上线。
木头：OK，谢谢老付和小陈的支持。那我们先把这个bug优先级调一下吧。
小陈：改好了。
小陈是会议现场“唯二”带着笔记本的，木头也在用笔记本投屏。不过小陈眼疾手快地打开bug直接调整了优先级。
小陈：你刷新一下仪表盘看看。
木头猛按了一下F5，“上线仪表盘”网页刷新了，最新的OOM bug按优先级排序跃升已知bug榜单第一名，同时bug关联的版本所属内部自测环境“Team Ring”由绿转红，描述符由“Healthy”转为“Blocking”（上线受阻）。
木头：这个看着挺吓人的哈，是不是内部自测用户也有爆出这个问题的？有没有影响他们体验？
小陈说：这个bug用户可能不太容易察觉到，相当于应用程序在后台的时候会默默‘死掉’，导致新功能不能用，但是在前台的时候可能感知不到。
木头：了解，但是这个问题肯定要在1.2版本解决，不然新功能挂了就白上了。可能老付这边帮忙看看这个问题，后续找到原因和方案也和大家分享下。
老付：没问题，我们研发后面举行一个‘Postmortem’（尸检，即问题版本反思会议），回顾和总结一下这个问题。同时我们看看是否可以在开发过程中、持续集成流程中，引入相关的代码审查、静态代码分析和单元测试，争取让它‘Fail Fast’。后面如果这个问题复现有难度，还要小陈协助下。
小陈：好嘞，没问题。
木头：大刘，咱们目前的版本上线处理，有没有建议？
大刘：嗯，1.2.2有问题那先回滚到上一个没问题的版本吧，貌似要回滚到1.1.15？
木头：对。
大刘：好的。后面这个新版本修复了也请告诉我一下，我们有外部的合作客户很期待1.2版本的新功能。另外，既然每次测试可以发现一些问题，我们是否可以优化一下流程，小陈那边全测试完毕后再开始内部自测环境上线，毕竟咱们自测的用户都是同事，他们的体验也要重视。
小陈：我没意见，可以的。
小陈听到要把自己负责QA的流程进一步前置，觉得机会很好，马上表示赞同。
木头：嗯，这个议题可以讨论，内部自测用户群20%上线和QA自动化回归测试同步进行，我是知道之前咱们把这两件事并行的考虑，主要是考虑到自动化测试还有一些不稳定因素，有时候报出的问题不一定准确，就用内部自测的用户运行情况做一个佐证。咱们会后讨论一下这个事情，现在先看看关于上线，各位同学还是否有其他问题。
大刘：Beta环境的1.1.14版本貌似有一个corner case的问题要修复对吧，影响千分之一的用户，目前在1.1.15修复了。
老付：是的，我们在beta环境看到有很少的用户报出这个问题，但这个如果上线到生成环境，会影响生产环境300多万用户的体验以及相关量化指标，所以及时进行了修复，把修复的改动从主分支迁移到了相关上线分支，1.1.15目前看不到这个问题了，而且1.2的版本以及后续的版本都会包含这个修复。”老付转头对木头说：“木头，咱们1.1.15是不是就可以上beta了。”
木头：对，这么重要的话题我差点忘了。我会后就操作上线，需要老付和大刘你来在系统上审批通过下。
木头看到仪表盘上显示，Alpha环境的1.1.15版本已经在这个环境下停留了5天，有2000多日活用户，没有新增问题，数据指标都比较稳定，觉得有把握继续上线。
大刘和老付：好的，没问题。
木头：应该没有其他议题了，感谢各位参加！有相关问题随时找我。
一场紧张刺激的发版大作战会议就这样结束了。
 
图17-1 软件发版“作战部队”和“作战室”

### 17.1.2 软件发布和软件质量

一个成熟的开发团队，软件发布的过程应该是对全团队透明的，一个新版本最终一步步上到生产环境，是整个开发团队辛苦工作开花结果的过程，尽管这个过程包含着机遇与风险，但一旦顺利达成，是一件非常值得庆祝的事情。“Ship it!”是一句令人振奋的口号。
相应地，一旦失败，一个重磅的漏洞或bug逃过了层层检测，落到了生产环境，由线上用户报出来反馈给媒体，那就不是开花结果，而是“落地大瓜”。打击整个团队的信心，危及到产品的成败。对于产品负责人和决策者，一方面要重视软件质量保障，未雨绸缪，防微杜渐，重视代码质量和相关流程的完善，把这种文化推广到团队；另一方面，要鼓励大家把看到的问题讲出来，并用一些量化的可视化工具呈现出来，勇于面对问题，还原和讲出质量“真相”。工具和自动化随人可以帮助保证软件质量，但其成功最终落在每一个团队伙伴对质量的追求和重视上。

