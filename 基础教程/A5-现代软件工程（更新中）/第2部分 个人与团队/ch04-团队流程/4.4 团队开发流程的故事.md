## 4.4 团队流程的故事

下面是木头曾参与过的几个项目的故事。


### 4.4.1 项目 A - 多智能体强化学习平台

<img src="Images/Slide6.JPG"/>

#### 项目规模

这本来是一个中型的项目：一个 dev manager，一个 tech lead，六个 dev，两个研究员，没有 PM 和 Designer。后来退化成一个微型项目，只有两个 dev。

#### 项目背景

一个跨国海运公司在世界各地的港口都有空的集装箱，需要及时地转运到所需要的港口装载货物。如果用传统的优化算法，每次计算需要花费好几天的时间，而且还不能克服一些临时的因素造成的误差，造成空集装箱没有正确地达到需要的港口。

所以研究员们用多智能体强化学习算法，成功地解决了这个问题。

#### 要解决的问题

和这个海运公司的合同结束后，研究员和工程师们想把这个算法发展成为多智能体强化学习平台，以便可以方便地解决类似问题。为此，建立的了一个开源项目：MARO（Multi Agent Reinforcement Learning）

但是只有海运这样一个实例的话，是无法泛化的，于是研究员和工程师们又找了共享单车搬运、虚拟机管理、仓储库存管理等几个例子。

#### 关于例会

木头是在这个平台开发了一年后后才加入的这个项目。一进来就发现 tech lead 定的例会是每周一、三、五，这就很尴尬：因为周五以后就是周末，如果每个 dev 想在周一的例会上说出点儿什么来，就必须在周末花时间做出进展来。大家轮一圈儿后大概要花 30 分钟，而且那个 tech lead 特能说，每次都讲很多，关键是在例会之外，他还会时不常地单独和每个 dev 练习，一讨论就是一个小时，语气很强硬。

那个 tech lead 很快就离职了，木头接替了他的职责，第一件事就是把以前的例会取消，然后重新建立了每周二、四两天的例会，每次例会大概 15 分钟左右。

#### 开发资源调整

这位 tech lead 把摊子铺得很大，所以每天都很忙的样子。他和研究员的关系比较密切，对研究员是言听计从。他在离职和木头的交接期间，有个研究员跳了出来主持例会，给各个 dev 安排任务，还给木头安排了以个任务，木头只是不知可否地笑了笑。木头和老板汇报了这件事，老板觉得是不可接受的：“我们虽然开放合作，但是还没有开放到可以让别的组的人来指挥我们的 dev 工作。” 

于是，木头就接管了这个项目。其实这是个烂摊子，没有明确的用户，只是在 GitHub 上开源了一个项目，还弄了一大堆人，没有能产生生产力的产出，没有明确的计划，相当于是一个工程团队在搞研究。

木头和领导建议，把部分人力调配到了量化交易的项目上，这边只留两个 dev，继续支持研究员关于仓储管理的项目研发，但实际该项目上也没有明确的用户。

后来，领导和木头说，把这个项目交给 3.4 节中的女生 J，木头很痛快地答应了，但是每周的两次 sync 还是一起开，木头发现女生 J 作为 tech lead，她自己很少写 code，只做 code review。

#### 项目特点

- 没有明确的用户需求，所有需求都是研究员和工程师们自己想的。
- 没有用户声称他们自己使用了这个平台，部分原因是强化学习对于大多数人来说还很陌生。
- 老板们对这个项目也没有什么预期。

#### 最终结果

这个项目开源三年多了，至今还在有人维护，处于半死不活的状态，在 GitHub 上只有 660+ 颗星。


### 4.4.2 项目 B - Torch Nebula

<img src="Images/Slide7.JPG"/>

#### 项目规模

这是一个小型项目：一个 dev manager，一个 tech lead，四个 dev，没有 PM 和 Designer，first party（内部）用户。

#### 项目背景

在使用 PyTorch 训练大型神经网络模型时，往往使用分布式训练，以数据分布式居多。这种模型往往需要几天甚至几周的时间才能训练完毕，这就需要在训练过程中间歇性地保存当前的训练进度，以备万一机器掉电或框架软件错误造成中断时，可以把最近一次的保存进度加载进来继续训练。

#### 要解决的问题

由于网络参数过大，调用 torch.save() 函数保存进度写入硬盘往往需要一个多小时，然后才能继续训练，是一种阻塞式的行为。我们的目的就是要提供一个可导入的 python 包，当用户调用这个包提供的 nebula.save() 函数时，可以用异步的方式在后台保存进度，只需要 1 分钟左右的延迟就可以继续训练任务。

#### 关于例会

刚一加入这个项目，就发现他们每天上午 11 点都有例会，通过 Teams 开的在线会议，大家 sync 进度，scrum master 是 Tech Lead。他会询问每个人的进度，有问题的话就讨论以下解决办法，或者提醒要注意的关键点。经常进行一些发散性的讨论，造成了一轮 sync 下来会花 40 分钟以上的时间。

初来乍到，木头也不好说什么，就听着呗，轮到自己时就简单说两句。这种每天 sync 的好处就是：Tech Lead 可以清楚地知道每个人的进度及当前状态，而每个 Dev 如果想在第二天的会上说出点儿什么来，必须在前一天花时间完做出质性的进展，很大程度上杜绝了“摸鱼”现象。

但是，每天花 40 分钟有点儿太耽误大家的时间了。另外，项目本身的难度不是很小，所以每天不一定有实质性进展。

#### 开发流程

- 木头是以帮忙的身份来加入这个项目的，从零开始建立一个 CI Pipeline，可以把 dev 们提交的 code 在 Pipeline 里自动编译、打包、部署到测试环境，如果测试成功则允许 merge。

- 团队除了每天上午开一次例会以外，每周五下午向上层的老板做一次回报，本周做了什么，下周准备做什么，用户有什么反馈等等。老板关心的问题就是：有多少用户在用了，使用情况如何。

- 在日常工作中，如果用户或者我们自己发现了什么 bug，就记录在 Azure DevOps 上面；如果有什么新想法，也会以 Feature 的标签记录在 DevOps 上，作为 backlog。

- Tech lead 在例会上看每个人的进度，如果没有任务积累，就会从 backlog 中拿出一项优先级比较高的任务来分配给这个人。当然，像木头这种比较资深的 dev，会自己主动挑任务：或者是自己感兴趣，或者是对了解全局有帮助，或者是自认为比较重要的。

- 每个人要做新功能时，都需要先写一个设计文档，可简可繁，tech lead 找相关人员评审后方可继续。

- 日常的 1:1 的讨论比较多，有时候会直接跑到对方的座位旁对着屏幕讨论。

- 大家都很友善，会帮助新来的同事答疑解惑，这让木头感到很舒服，比起上一个团队来可是强多了。

- 没有外部的需求要求我们做什么功能，都是自己想出来的。

- 每两周会总结一下进度，作为一个 Sprint，但是并不严格，因为很多时候计划的任务两周做不完，就会用三周时间。老板也不会催促。

#### 项目特点

- 需求是客观存在的，而且是刚需，但并不是由用户提出来的，而是由 feature team 自己发掘的。
- 没有明确的进度要求，只有一个大的方向。

#### 最终结果

当木头离开这个项目组时，已经有不少用户使用了 Nebula，反响很好，也得到了领导的夸赞。

### 4.4.3 项目 C - 量化交易

<img src="Images/Slide8.JPG"/>

#### 项目规模

这是一个中小型的项目，一个 Dev manager，一个 Tech lead，五个 dev，两个研究员，一个 PM，一个商务人员，一个外部的长期合作的客户（某基金公司）。

#### 项目背景

MSRA 的研究员们研究股票的量化交易很多年了，并建立了一个开源项目：QLib。可是缺少实盘的机会。某基金公司听说以后，决定和 MSRA 合作，基金公司提供数据，由研究员们提供算法、模型、预测结果，基金公司参考预测结果再结合以往的投资经验来操盘。

#### 要解决的问题

每个交易日，基金公司都要手工上传昨天的交易数据，用微信叫醒熟睡的研究员，研究员去下载交易数据，处理后用模型做预测，然后微信通知基金公司取结果。整个过程基本没有自动化。

每过 60 个交易日，基金公司就要求研究员使用最近的历史数据重新训练模型，在历史数据上比较新旧模型的差异，然后切换模型。这个过程也都是手工完成，很繁复。

木头的任务就是把上述过程工程化、自动化，省去手工操作的麻烦和误操作。


#### 关于例会

- 每周二、四，木头会安排组内会议，大家 sync 一下当前进度。

- 每周五收盘后，和客户开一次例会，由研究员分享最新的研究成果。开会时客户那边一般是两三个人，我们这边三个工程师、两个研究员、两个商务人员、一个 PM 都要参加。

- 每两周，开发团队要和研究员们做一次内部例会，工程师们汇报系统设计及开发的进展。

#### 开发流程

- 木头作为 Tech lead 负责开发团队，安排一个 dev 做推理预测部分的工程化，两个 dev 接手改造陈年失修的数据处理 pipeline，两个 dev 做训练部分的工程化。

- 在正式开始之前，木头先把任务做了粗粒度的分割，估算每个部分所需开发时长，并用此时间来对内对外宣布，一是给内部人员一个紧迫感，二是给外部人员一个预期。

- 木头自己画了很多图，并配以较少的文字，来说明整个系统的架构，一是用于对内统一思想，一是用于对外汇报。

- 每次做一个新模块，木头会要求相关人员写一个简单的设计。因为木头发现，某些 dev 很快就能做出一个功能模块来，但是在 sync 时发现设计太复杂，不利于后续人员的理解和后期维护。

- 所有工作都在 Microsoft Azure 上进行，因为客户买了 Azure 的订阅。

#### 项目特点

- 用户的需求很模糊，只是要求快、准、自动化。

- 用户只有一家。

- 因为涉及到上亿的投资规模，所以用户很谨慎并且苛刻，每上一个新功能都要严格把关，要求我们能够做到自验证。

- 甲方强势，乙方必然弱势。微软这边投入了大量的人力，但是合同金额并不大，只是为了能够把研究成果市场化。

- 工程师作为辅助角色，没有很多的话语权。

#### 最终结果

大家用了四个月的时间，终于把所有的训练系统、推理系统、模型管理系统做到了自动化，客户很满意。

还有一点：自动化训练系统使用多 GPU 机器并行完成，在工程化过程中经过了多轮的测试以验证其稳定性，结果用爆了用户的订阅额（quota），促使用户在下一期合同的时候购买了翻倍的订阅额。

### 4.4.4 项目 D - ONNX Converter

<img src="Images/Slide9.JPG"/>

#### 项目规模

这一次的项目个大家伙：ONNX 其实是一个产品，整体大概有 200 多人。木头参与的是其中一个子项目 ONNX Converter，算是中等项目吧。一个 dev manager，没有 tech lead，10 几个 dev，而且分布在美国、法国、中国等四个办公地点。

#### 项目背景

ONNX（Open Neural Network Exchange）开源项目，开放的神经网络模型交换格式。作为框架共用的一种模型交换格式，使用 protobuf 二进制格式来序列化模型，可以提供更好的传输性能我们可能会在某一任务中将 Pytorch 或者 TensorFlow 模型转化为 ONNX 模型(ONNX 模型一般用于中间部署阶段)，然后再拿转化后的 ONNX 模型进而转化为我们使用不同框架部署需要的类型，ONNX 相当于一个翻译的作用。

另外，在微软，所有训练出来的模型，最后都会用 ONNX 格式做线上推理。

#### 要解决的问题

用户使用各种深度学习框架搭建的模型，互相之间不能互相转换，而且各个框架着重于训练，而在推理方面则速度较慢。ONNX 作为模型推理平台，可以提升速度，简化环境部署依赖。

木头负责其中的 Scikit-Learn 模型到 ONNX 模型的 converter 的维护，也接触了 PyTorch 模型到 ONNX 模型的 converter。还有人负责 TensorFlow 模型到 ONNX 的 converter。主要框架早已经搭建好了，但是在用户使用过程中会发现不少 bug，以 GitHub issue 的形式记录下来，大家认领属于自己领域的 bug 去修复，而这些 bug 绝大多数是前面的开发者遗留下来的。

<img src="Images/Slide7.JPG"/>

#### 关于例会

Dev manager 在美国，每周一下午（中国时间是周二早晨）开例会，有美国人（分布在东部和西部两个时区）、印度人、中国人、法国人，大家用英语，每个人简单说一下自己在干什么，而且要有 GitHub issue 或者 PR 的 link 来证明。

#### 开发流程

- 每半年会重新调整一下工作重点。

- 在这半年中，至少会有 2 次 milestone（里程碑），用于把积累的功能发布为新版本。

- 每周写一次汇报，内容是：上周做了什么，遇到什么困难，本周打算做什么。

- 除了 dev 自己找任务外，Dev manager 也会根据每个人的 workload 分配一些任务。

- 每周例会时，先是很快地 sync 完进度，然后会有一个人（轮班制）讲他是如何解决一个问题的经历，供大家学习参考。

- 代码评审都是找与自己同时区的 dev 来做，避免跨洋交流。至少有一个人做了 code review 并 approve 后才能 check in 代码。

- 有已经搭建好的 CI Pipeline，里面有大量的 UnitTest，每次 check in 代码必须经过 pipeline 的检验，所有 test case 都通过了才能继续。

#### 项目特点

- 这是一个维护型项目，框架已经定型，主要的任务是解决 bug，提高 user experience。
- 人员分布比较散，没有明确的进度要求，工作全靠自觉。

#### 最终结果

直到现在这个项目还在处于维护阶段，解决了用户的大量典型问题，让 ONNX 更好用。
