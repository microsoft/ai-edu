
## 4.6 大中型系统的最佳实践


### 4.6.1 基本步骤

面对大中型软件，因为我们要采用敏捷的开发模式，而且要有不同团队直接的合作，所以工作步骤与小型软件完全不同。基本步骤如下：

#### 确定架构

如图 4.6.1 左子图所示，经过系统分析后，架构师认为应该把系统的技术栈分成以下五层：

- 交互显示层
- 缓存控制层
- 辅助功能层
- 核心功能层
- 基本数据层

并且有了相应的原型代码来验证其可行性。

<img src="Images/Slide10.JPG"/>

图 4.6.1

#### 框架实现与接口设计

如图 4.6.1 中子图所示。

- 首先把各个层的基本框架代码写好，可以不做具体实现；
- 然后定义相邻两层之间的接口，可以先按照做原型程序的步骤实现一两个接口。

#### 垂直切片

如图 4.6.1 右子图所示。

- 选择一个功能，依次在技术栈的五个层内做具体的模块实现，并根据实际需要随时调整框架和接口的设计。
- 必要的模块实现好后，把它们从上到下串起来，应该可以形成一个完整的功能。

#### 后续步骤

重复“垂直切片”的步骤，逐步增加功能。

在开发新的垂直切片功能时，需要注意以前的模块是否可以复用。如果需要修改，切记要经过充分测试，不要破坏已有的垂直切片的功能。

每一块垂直切片就相当于一块电池板，有正负极，有外壳容器，有化学反应剂等等。如果只有一块电池的话，可以提供 12V + 1A 的直流电功率。当电池逐渐多起来时，根据串并联方式，放到一个大盒子内（框架）固定，可以提供更高的电压或更大的电流，整个电池组的输出功率就提高了。

### 4.6.2 举例

我们仍然用计算器应用这个简单的例子来做说明，并假设它是一个非常复杂的软件，每增加一个按键、一个功能、一个显示字符都很花时间。

<img src="Images/Slide11.JPG"/>

图 4.6.2

如图 4.6.2 所示，其中：
- 上半部分圆圈内的数字 1,2,3 表示三个阶段的垂直切片的实现。
- 两条竖线严格分开了代表垂直切片的三个阶段的实现功能集。
- 下半部分暗色的矩形内的功能是最终要实现的功能全集。
- 下面的五条横向虚线代表了该系统的技术栈的五层，在表 4.7.1 中描述。

表 4.6.1

|技术栈|第一阶段<br>（简易加法计算器）|第二阶段<br>（加减法计算器）|第三阶段<br>（四则运算计算器）|
|--|--|--|--|
|界面显示|简洁合理|应有尽有|美观细致|
|字符数量|只能显示五个字符|能显示十个字符|可以显示任意多字符，横向滚动|
|辅助功能|等号|等号、删除|等号、删除、M+、M-、MC|
|计算功能|加|加、减|加、减、乘、除|
|数字按键|123|123456|1234567890|


技术栈一共有五层：

- 界面显示

    即最终用户可以看到的界面，包括各个界面元素的颜色、尺寸、线宽、间距、位置等等，这些都需要 Designer 的精心设计。
    举个例子，0~9 这 10 个按键在界面上应该如何排列？想当年贝尔实验室设计电话按键时，其实排在第一位的按键布局是下面这个：
    ```
    1 2 3 4 5
    6 7 8 9 0
    ```
    但是太宽了，所以最终设计成这样：
    ```
    1 2 3
    4 5 6
    7 8 9
      0
    ```
    原因是最初人们在公共电话亭站着打电话时，“1 2 3”距离人的视线较近。但是计算器的键盘设计却都是相反的：
    ```
    7 8 9
    4 5 6
    1 2 3
      0
    ```
    原因相同：人们坐着按计算器时，“1 2 3”距离人的视线较近。

- 字符数量

    即可以在输出区域显示的字符数量，这涉及到输出缓冲区的设计，及界面的设计。缓冲区的大小不是什么问题，因为计算机的内存足够大。但是如果界面输出框宽度为 8 厘米，字号为 24pt 时只能有 10 个左右的字符可以显示。

- 辅助功能

    包括等号键、回退删除键、存储加键、存储减键，存储清空键。

- 计算功能

    包括“加、减、乘、除”四种操作。当然对于复杂的计算器来说，还会有指数、对数、乘方、开方等操作符，可以在后期继续增加垂直切片。

- 数字按键

    从 0 到 9 的按键输入，属于输入功能界定，并非指的这 10 个按键如何在界面上呈现。更加复杂的功能是可以输入二进制或十六进制的数字。

#### 第一阶段：简易加法计算器

- 数字按键只支持“1,2,3”；
- 计算功能只支持“加法”；
- 辅助功能只有“等号”；
- 显示字符数量最多 5 个；
- 界面显示以“简洁合理”即可。

这个计算器可以给学龄前儿童使用，用于数学启蒙教育。

#### 第二阶段：加减法计算器

- 增加数字按键支持“4,5,6”；
- 增加计算功能“减法”；
- 增加辅助功能“回退删除”；
- 显示字符数量最多 10 个；
- 界面显示可以做到“应有尽有”。

这个计算器可以小学一年级学生使用。如果数字键增加到 “7,8,9,0”，就可以给任何只需要用到加减法的人使用。

#### 第三阶段：四则运算计算器

- 增加数字按键支持“7,8,9,0”；
- 增加计算功能“乘法,除法”；
- 增加辅助功能“M+,M-,MC”；
- 显示字符可以滚动；
- 界面显示“美观细致”。

至此，设计的功能全都实现了。这个计算器可以给会计、销售等行业人员使用。

好处：

1. 尽快出原型产品交付给用户并得到反馈，避免到了最后阶段才发现需求分析阶段出现的偏差。可以说是一种保险措施。

2. 每个开发周期都有明确的、可以实现的目标，做了这种任务分解后，开发进程变得清晰可控。对于负责技术栈中的各个层的软件工程师来说，每个开发周期只集中精力在一个功能上，其它时间可以用于框架优化，也有助于提高产品质量。

3. 验证各层之间的接口设计是否合理，可扩充性是否好。当然在产出第一个原型时，需要先把系统的基本框架搭建好，这需要花一定的时间。通常框架搭建的时间是构建整个产品的总时间的十分之一到五分之一，如果框架设计的好，接口制定得合理，后续的功能实现会非常的容易。

### 4.6.3 几种验证工具

在开发复杂的软件系统时，尤其是面对一些前所未有的功能时，没有前人经验可以借鉴，并且没有人可以确定它能做还是不能做。这时就需要一些工具来帮助人们做快速的验证。经常用到的是：

- 概念验证（PoC，Proof of Concept）
- 原型开发（Prototyping）
- 最小可行产品（MVP，Minimum Viable Product)

<img src="Images/Slide12.JPG"/>

图 4.6.3 

表 4.6.2

|比较项|概念验证|原型开发|最小可行产品|最终产品|
|--|--|--|--|--|
|生命周期|极短（日）|短（周）|中（月）|长（年）|
|成本|极低|较低|中等|最大|
|发布|不发布，仅内部使用|定向发布|阶段性发布|公开发布|
|作用|验证技术难点|确认用户需求|及时得到反馈|获得最大收益|
|风险控制|技术实现风险|需求理解风险|整体构建风险|需求、技术、人员、时间、过程等各种风险|

#### PoC（Proof of Concept）概念验证

目标：验证某个想法是否在技术上是可行的。

PoC 的主要目标是测试这个想法在技术上是否可行，是否值得追求。这不是为了发现用户需要什么，或者是否有解决方案的需求，而是从技术角度来看，是否有可能并且值得追求这个想法。

毕竟，你不想对一个比你最初期望的要难10倍（而且更昂贵）实现的想法进行全面的思考。这可能是一次快速的尝试，以开发风险最大的技术假设的测试版，或者只是对现有技术可能性的更深入分析。

比如，想实现的新功能强烈依赖的核心技术是 OCR，而自己临时做一个 OCR 是不可能的，那就需要：

1. 找到现有的商业化 OCR 解决方案去做试验；
2. 多找几个提供商，看看哪一家的识别率更好，价格更低；
3. 有条件的话后期自己做一个。

概念证明通常不与最终用户共享，而是用作内部工具。

特点：
- 极短的生命周期；
- 极低的成本；
- 为后面的原型、MVP 提供参考；
- 内部使用，有时候也可以分享给甲方；
- 帮助估算后期的开发时间；
- 降低尝试去完成一个不可能完成的任务的风险。


#### Prototyping 原型开发

目标：以最低成本收集早期反馈

原型设计努力向我们展示产品开发后的样子。虽然PoC更多地关注“引擎盖下”（用户看不见）部分，但原型设计更多地关注UX/UI部分。目标是在预算上建立一个简单的、实验性的想法模型，以在投资实际产品之前测试和验证概念。

几乎任何东西都可以是原型：纸上的线框、数字演示、模仿网站的 PowerPoint 演示等等。尽早获得反馈和发现想法中的漏洞的能力可能是产品成功的决定因素。

当然，有些原型开发也是需要代码的，这些代码可以是粗制乱造的，只要能完成任务即可。

特点：
- 较短的生命周期；
- 低成本；
- 集中在朴素的想法实现和界面/交互部分；
- 可以对整个产品做原型，也可以只针对其中的一部分做原型；
- 分享给甲方，可以尽早得到反馈；
- 降低与预期需求不一致的风险。

#### MVP（Minimum Viable Product）最小可行产品

和上面讲的垂直切片概念类似。

与“垂直切片”法的概念不完全相同，按功能，按质量评价维度

功能完整性
高可靠性
可用性
完美


目标：尽快、廉价地推出产品，验证假设，收集用户反馈，并迭代。

MVP应用程序开发是关于构建一个产品版本，该版本将在市场上提供，真实用户可以与之交互。

其核心思想是在向最终用户提供价值主张的同时，尽可能少地包含功能，并满足尽可能多的市场需求。

它是关于构建产品的连续循环，然后测量和测试您的假设和猜想是否正确，收集用户的反馈，从中学习并改进产品，然后一次又一次重复。

专注于MVP开发而不是一些成熟的解决方案可以降低交付不需要的产品的风险，并允许您根据市场反应以低成本进行转向。

在真实市场上测试产品总是至关重要的，即使你已经验证了你的原型，主要是因为人们通常不知道他们想要什么，他们只是认为他们知道自己想要什么。

特点：
- 正常的功能开发生命周期；
- 中等成本，大于原型的成本；
- 可以发布到市场面向用户；
- 验证一些假设而无需构建整个产品。


<img src="Images/Slide13.JPG"/>


在图 4.6.4 中，用金字塔形状列出了 4 层，而其内容分别是：

1. 功能正确性（Functional）
2. 高可靠性（Reliable）
3. 可用性（Usable）
4. 完美（Delightful），用户满意

为什么列出了这四个层次呢？

因为 1,2,3 三个层次都是软件质量的评判标准，虽然还有其它一些质量特性，但是针对最终用户的话，只有这三点是可以感受到的。关于质量特性我们在第 6 部分再详细介绍。

首先要求功能正确性，并不是说一次性要提供 10 个功能，而是只提供 2 个功能时，要保证这个 2 个功能是完全可以工作的，从输入、计算到输出，都是符合预期的。

其次是高可靠性，即不分时间地点的多次输入，都可以得到预期的输出。

再次是可用性，即界面友好，用户基本上不需要经过特殊培训就可以使用。用户可以方便地输入，比如当打字不方便时可以用语音输入。并且可以得到明确可见的输出。

前三者都具备的情况下，就可以是令用户满意的完美软件。



在《构建之法》一书中的第五章已经做了一些说明，在此补充一下


