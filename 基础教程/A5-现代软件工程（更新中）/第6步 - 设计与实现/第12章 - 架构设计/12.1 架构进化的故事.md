## 12.1 架构进化的故事

https://juejin.cn/post/6844904007438172167

还记得第一章中关于“木头与软件工程的故事”吧？这里有另外一个版本，是同样的应用场景，但是想说明的是软件架构进化的故事。

### 12.1.1 单机模式

我们首先假设木头有个熊孩子，还在上小学。数学不是很好，所以木头想了一个注意：每天出 20 道 100 以内的加减法算术题。这个对木头来说很容易，花了 1 个小时用 C# 搞定了一个小的应用程序。

**再小的软件也是有架构的，所以架构是可大可小的，能用小的、简单的架构解决问题，就不要用大的、复杂的架构。**

这个小应用程序的架构很简单：一个有界面的应用程序，显示出题目，孩子计算出结果后填入一个数字，提交，如果正确则进入下一题，错误则提示重做。那些题目是事先生成好的（经过人工核对，以保证不重复和一定的复杂程度），包括答案，放在了一个数据文件里。

自己家里就有一个台式机运行 Windows 10 操作系统，是平时木头业在余时间写书用的，性能还可以。于是就把应用程序和数据文件都放在一个目录中，在桌面上创建一个应用程序的快捷方式，孩子每次点击打开即可使用。

见图 12.1.1 阶段1。

<img src="img/Slide3.SVG"/>

图 12.1.1 架构计划-1

### 12.1.2 点对点模式

很快，木头发现一个问题：每天晚上如果孩子在使用台式机做题的时候，自己就不能使用。木头忽然想到家里还有一个比较旧的 Surface 笔记本电脑，于是拿出来升级到 Windows 10，性能还可以接受。

然后把应用程序拷贝到笔记本电脑上，数据文件仍然放在台式机上（这样木头就可以随时在台式机上维护那个文件），用点对点网络共享的方式把数据文件共享给笔记本电脑，这样在笔记本电脑上的应用程序可以像读本地磁盘一样打开数据文件。

于是，父子俩每天晚上都可以在局域网内共同使用电脑了。见图 12.1.1 阶段2。

### 12.1.3 客户端/服务器模式

熊孩子和同学们吹嘘自己在用电脑做算术题，同学们很羡慕。其中有个同学就住在木头家的隔壁，哭着喊着带着家长过来学习先进经验。

木头本来想把这个应用直接拷贝给邻居使用，但是邻居基本上是个电脑盲。木头忽然想到 Wifi 信号可以穿墙，于是在无线路由器上开了一个端口给邻居，并让邻居买了一台二手笔记本电脑，装好 Windows 10 操作系统和应用程序软件，登录到木头家的路由器。自己家的笔记本电脑也登录到同一个路由器上。

但是两台笔记本电脑操作同一个数据文件会产生一些读写冲突，木头又花了几个小时的时间把对数据文件的读写改成了数据库读写，SQL Server 数据库（个人版）部署在自己的台式机上，两台笔记本电脑可以同时访问数据库获得习题并提交答案了。

其实这种模式还不是标准的客户端/服务器模式，只能算是网络数据库模式，如果把数据库看成是服务器的话，也勉强算是客户端/服务器模式。

见图 12.1.1 阶段3。

### 12.1.4 浏览器-服务器模式

熊孩子的进步突飞猛进，引起了老师的注意。经过询问后得知有这么一个好工具，立刻和教务处及校长汇报，然后联系木头寻求合作。

面对下一代的教育问题，木头当仁不让。但是，如果全校师生都用的话，需要做的改动有（其实是重新设计开发）：
- 要有广域网（互联网）的支持，因为同学们是在各自的家中使用；
- 题库需要很大的改进以满足各个年级的需要，并且用一个强壮一些的数据库来存储题库，如 SQL Server 企业版，可以有很多并非连接；
- 软件也需要重新进行架构设计，因为不能要求所有的学生都有一台 Windows 10 的电脑，所以必须改成浏览器/服务器模式；
- 由于是业余练习，目前还不需要记录成绩，所以在服务器端配置一台 Web 服务器连接数据库，允许简单的上传下载功能即可。

木头寻思了一下，这个事情自己一个人做不了，后期还需要持续升级维护，所以和公司领导汇报，看看是不是能组织一个小组来试水教育领域的软件开发。领导很支持，调配了 3 个人和木头一起花了一个月的时间完成了这件事。

见图 12.1.2 阶段4。

<img src="img/Slide4.SVG"/>

图 12.1.2 架构进化-2

### 12.1.5 主从模式

运行一段时间后，数学老师们觉得效果非常好，校长知道后也很高兴，就想把这个模式推广到其它学科。于是，除了体育老师以外，其它学科的老师纷纷找木头讲述需求，木头忙得脚丫子朝天，把小学课程整个都复习了一遍，觉得知识很生疏。

在开发小组向数据库中增加题库，并在 Web 服务器上增加新的入口的同时，木头感觉全校的上千名学生同时使用这个系统的话，数据库访问会是个瓶颈。于是和校长/教务处商量，又购买了两台数据库服务器，与已有的一台数据库配置成了主从关系，即：

- 主数据库负责写入，然后同步给从数据库；
- 从数据库负责查询/读出，并且有负载均衡。

这样就基本解决了数据库的压力，而 Web 服务器的压力，目前预测还可以承受，上线后先观察一下再说。

见图 12.1.2 阶段5。

