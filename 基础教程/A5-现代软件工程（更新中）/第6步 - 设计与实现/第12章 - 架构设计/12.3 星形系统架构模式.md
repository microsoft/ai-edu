## 12.2 星形系统的架构模式

### 12.2.1 客户端-服务器模式（Client-Server）

这是一种最传统、最基本的模式，简称为 C/S，是其它一切模式的基础。见图 12.2.1。

<img src='img/Slide10.svg'>

图 12.2.1 客户端-服务器架构

#### 架构说明

最早的软件都是在主机（大型机或小型机）上开发的，使用者用哑终端方式通过串行接口接入到主机，实际上所有代码都是在主机上运行，因为哑终端只有输入、输出功能，没有计算能力。

后来出现了个人电脑 PC（Personal Computer），运算能力很强，并且有了局域网络。这两个技术突破让人们可以重新构建代码，把关键逻辑和数据放在主机（后称服务器）上，在终端（后称客户端）上运行本地逻辑（用户专用）和界面，并通过快速的局域网络与服务器进行通信。主动发起请求的叫客户端，响应的一方叫服务器。当然，相比之下服务器的运算能力更强，是专用的商业计算机。

客户端-服务器模式由两个部分构成：**一台**服务器与**多个**客户端，拓扑结构为星形。服务器组件同时为多个客户端组件提供服务。客户端向服务器发启服务请求，服务器将相应服务信息回应给客户端。此外，服务器持续监听来自其它客户端的请求。二者之间一般采用 TCP/IP 网络协议，传统的架构是局域网，但是现在互联网速度很快，所以可以扩展到广域网。

#### 扩展模式

- 有些时候一台服务器不能满足客户端的所有请求，比如：在档案管理系统中，服务器 1 只负责处理查询身份证号码的请求，而服务器 2 只负责处理更改个人信息的请求。那么在客户端 1 中，不同的用户请求会发送到不同的服务器上，这是在客户端代码中预先配置好的。而在服务器端，服务器 1 的内存可能会比较大，因为它可以缓存成千上万个身份证号码，便于快速得到查询结果；而服务器 2 的硬盘（存储设备）读写可能会比较快，因为它要快速地更新数据。

- 还有一种可能就是两个客户端的权限不一样，客户端 1 权限较高，可以提供所有功能；而客户端 2 权限较低，只能提供部分功能。这在银行系统中常见：有的机器只能自助取钱，而另外一些机器可以存钱和取钱。

- 有些负载均衡网络设备，可以把客户端请求均匀地分配给服务台集群中的每一台服务器。也可以在服务器端软件中实现简单的负载均衡，即每次用户请求时先返回本服务器的繁忙状态：如果很忙，则告诉客户端访问其它服务器；如果不忙，则继续请求/响应；如果所有服务器都忙，则在客户端显示系统繁忙信息。

#### 优缺点

优点：

- 开发阶段可以在两端分两组同时进行。
- 客户端与服务器分离，排查错误方便。
- 一个服务器可以服务于多个客户端。
- 当多个服务器可以同时提供服务时，单个服务器的升级很方便。
- 安全，所有数据都存储在服务器上，可以更好地控制访问和资源，以保证只有那些具有适当权限的用户可以访问和更改数据。
- 由于数据的集中存储，数据的更新更容易。

缺点：

- 当计算任务较重时，服务器可能成为瓶颈。
- 当数据传输较多时，网络带宽可能成为瓶颈。
- 需要客户端具有一定的计算能力。
- 当客户端较多时，升级客户端软件不方便。
- 当客户端操作系统不同时，需要开发多个版本的客户端软件。

#### 应用场景

当需要在个人电脑内下载、安装软件，并且必须有服务器端的支持才能工作时，这类的应用都属于客户端-服务器模式，比如：

- 公司内的电子邮件服务
- 公司内的文件共享服务和打印服务
- 银行窗口业务
- 图书馆查询系统
- 联网游戏

目前使用的手机类应用，比如微信、淘宝、微博、京东等等，也都可以算作是客户端-服务器模式。

### 12.2.2 浏览器-服务器模式（Browser-Server)

此模式简称为 B/S，从 C/S 模式发展而来。见图 12.2.2。

<img src='img/Slide11.svg'>

图 12.2.2 浏览器-服务器架构

#### 架构说明

随着互联网的发展，尤其是：

- 广域网网络速度提升
- 浏览器引擎性能提升
- 浏览器开发框架成熟

这三点让人们意识到，如果把业务逻辑都挪到网页中，那么在客户端只要安装一个浏览器就行了，而无需为了 10 种应用安装 10 种客户端，这无疑对软件厂商和最终用户都有利。

#### 与 C/S 架构的比较

表 12.2.1 C/S 架构与 B/S 架构的比较

||C/S|B/S|
|-|-|-|
|硬件环境|客户端计算能力较强，几乎可以完成任何操作|客户端能运行浏览器即可，但可处理逻辑也相对简单|
|网络环境|局域网、安全的广域网|广域网、局域网|
|操作系统|指定的操作系统，比如 Windows|只要有浏览器即可，比如 Mac、Linux|
|安全要求|客户端和服务器的安全性都要考虑，安全性较高|只考虑服务器端的安全性，用户行为不可控|
|开发成本|购买费用和培训费用高|低|
|软件重用|不好|较好|
|系统维护|升级难，维护难|无缝升级，维护开销极小|
|常用场景|公司内部|公众用户|
|用户界面|专用的用户界面，美观漂亮，可定制程度高|会用浏览器即可，一般的软件都会设计得比较人性化|
|网络协议|TCP/IP|HTTP（基于TCP/IP之上）|

#### 应用场景

常见的是信息发布，但是由于浏览器技术的发展，几乎可以应用于任何应用场景。

从图 12.2.2 的组网实例可以看到，客户端可以使用任何操作系统上的任何浏览器。公司内部可以有自己的 Web 服务器，在局域网内直接访问内部的网页信息；通过路由器访问互联网上的外部 Web 服务器。

### 12.2.3 对等模式（Peer-to-peer）

这是客户端-服务器模式的双向扩展。见图 12.2.3。

<img src='img/Slide12.svg'>

图 12.2.3 对等架构

#### 架构说明

对等模式中的组件称之为对等体（peer）或节点，既作为向其他节点请求服务的客户端，同时也做为响应其他节点请求的服务端。节点可以在运行过程中动态地改变其角色，即，既可以单独做为客户端或服务端运行，又可同时作为客户端与服务端运行。

在没有出现服务的年代，一个小公司内部往往使用对等网络来共享资源，它是一种投资少、见效快、高性价比的实用小型网络系统，比如 10 台计算机以下。互联网时代，在网络的各个角落也可能存在一些节点，它们各自知道同伴们的网络地址，进行点对点通信。

#### 扩展模式

如果有多个节点，它们之间的两两互相连接也可以看作是对等模式。只从一个节点向外看，还是星形网络。

#### 优缺点

优点：

- 一个节点瘫痪时，其它节点还可以继续工作并提供服务。
- 可在网络的任何地方共享内容和资源。
- 由对等节点组成的网络易于扩展，而且比单台服务器更加可靠，不容易有网络瓶颈。
- 由对等方组成的网络可共享处理器，整合计算资源以执行分布式计算任务，而不只是单纯依赖一台计算机，如一台超级计算机。
- 用户可直接访问自己所在的节点计算机上的共享资源，在本地存储器上共享文件，而不必在远程服务器上进行共享。

缺点：

- 数据分布在每个节点上，管理困难。
- 升级软件时需要有计划地逐个节点升级，而且备份、恢复资源困难。
- 网络安全性差，资源分散，容易有薄弱环节
- 当用户所在的节点做为服务器时，会影响用户本地的计算性能。

#### 应用场景

- 网络文件共享系统：Gnutella 目前是一个分布式文件共享协议的名称，主要用于分享音乐文件。此名称有时也用来指该网络本身以及原始的 Gnutella 软件。
- 流媒体协议：P2PTV 与 PDTP，众多客户端访问媒体服务器所造成的压力是服务器所不能承受的，因此，当新的请求到达时，服务器会根据访问记录把请求转给刚刚访问了相关媒体数据的客户端，然后在两个客户端之间做媒体数据传输。
- 区块链：区块链是一个去中心化的数据库，由很多独立的节点组成，分布在世界各地，通过互联网相互点对点连接，每个节点都具有数据层、网络层、共识层、激励层、合约层和应用层，集体维护一个可靠数据库，可用于智能合约、证券交易、电子商务、物联网、社交通讯、文件存储、存在性证明、身份验证、股权众筹、金融征信等领域。

### 12.2.4 主从模式（Master-Slave/Primary-Secondary）

因为 Slave 这个词比较敏感，因此英文中更多地使用 Primary-Secondary，我们只要知道 Slave 不是“奴隶”的意思就好。见图 12.2.4。

<img src='img/Slide13.svg'>

图 12.2.4 主从架构

#### 架构模式

这种模式由两部分组成：主节点和从节点。主节点将工作分配给不同的从节点，并根据从节点返回的结果计算最终结果。图 1.2.4 右侧显示了主从节点之间分配工作的顺序图，其中有一个硬性的要求：初始任务必须是可以**分割**的。

主从模式是分治（divide-and-conquer）原则的一个例子。每个从节点都是独立的，没有任何共享状态，因为它们是并行运行，或者是在同一个主机的不同进程中，或者是在不同的主机上，所以主从通信的延迟可能是一个问题。

### 优缺点

优点：

- 读写分离。
- 适合读多写少的场景，大并发读取时，多个从节点可以提供负载均衡。
- 从节点数量扩展灵活。
- 不怕数据丢失，有很多个备份。

缺点：

- 同步延迟问题，主从节点上的数据在某一时刻有可能不一致，不适合于要求一致性高的场合。
- 如果有大量写操作，会集中在主节点上。
- 主节点发生故障会比较麻烦，自动切换的复杂度高。

#### 应用场景

那么什么叫做可以分割？注意“分割”这个词比较生硬，它并非智能地“分解”，也非理性地“分析”。有几种应用：

- 并行计算：把一批数据或任务整齐地拆分成 N 份儿，然后分配给 N 个从节点去处理。比如大规模的并行计算时，可以把多个矩阵的运算分配给多个从节点并行完成，再在主节点中合并。
- 容错：主节点把同一个计算任务分配个多个从节点，然后从最快结束运算的从节点那里获得返回结果，并返回给调用者；或者是比较所有从节点的返回结果，取相似性最高的结果（三个结果是1.512，一个结果是1.511，则取1.512），返回给调用者。
- 提供准确度：不同的从节点执行同一个任务，但是它们各自的实现方式不同，比如，一个是用神经网络推理，一个用线性回归做预测，还有一个用表格匹配法取近似值，最终在主节点上用一种策略来决定最佳结果，如平均值或最多相似值。
- 数据库复制：主数据库被视为权威源数据库，从数据库与之同步。在有读取请求时，主数据库把请求转给从数据库，以提高并非读取的速度；在有写入请求时，只发生在主数据库上，然后再同步给从数据库。

