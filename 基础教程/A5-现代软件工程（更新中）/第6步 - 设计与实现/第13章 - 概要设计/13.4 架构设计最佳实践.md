
## 13.4 架构设计最佳实践

### 13.4.1 统一设计方法

总结一下上个小节中的内容，目前软件工程领域有几种主流的架构设计方法，见图 13.4.1。为了下文中描述方便，我们分别用这几种方法的首字母作为该方法的缩写：R，U，C，T，O。

<img src="img/Slide16.SVG"/>

图 13.4.1 主流的架构设计方法

只从方法名称上看，可以引发一些联想，比如：

- 场景、用户、业务、上下文，这些词好像都代表了用户需求；
- 逻辑、结构，这些是描述静态功能那个结构的词汇；
- 过程、行为、运行，这些是描述动态行为的词汇；
- 开发、实现、代码，这些是描述编写软件代码的词汇；
- 物理、环境、技术，这些是描述网络节点硬件的词汇。

所以，接下来我们通过横向对比这几种主流方法，来发掘它们的共同点，以便得到一个统一的方法论。这种方法就好比 12.3.4 小节中描述的主从模式的工作方式：既然大家的意见有细微差别，那么就由“从节点”给出各自的答案，由“主节点”总结出来一个更准确的最终答案。

#### 1. 业务场景架构

前四种方法中都有反映业务需求的非技术架构，如 R-场景视图、U-用户模型、C-上下文图、T-业务架构。在软件工程中，如果从需求出发的话，第一张图应该是给用户看的，不妨叫做**业务场景架构**。该图中没有逻辑，只有一些大的功能区，用来区分系统/子系统的边界。这张图在 13.2 节中已经绘制好了，我们不妨拷贝过来到图 13.4.2 以方便阅读。

<img src="img/Slide9.SVG"/>

图 13.4.2 业务场景架构图

【最佳实践】

软件系统建设是为业务服务的，所有的系统建设都是为了解决业务问题。因此，首先做的是进行战略分析和业务场景架构设计，战略分析不在软件工程的范畴之内，所以我们只关心业务场景架构。

关注点在于：

- 这张图的目的是把用户的需求做分类，把一个复杂的系统分解成若干个子系统。那么要不要分解到模块级别呢？如果系统复杂，就不需要，而是把模块分解留到下一个阶段（子系统的概要设计）去做。

- 关注点在业务上，不要包含任何技术词汇或概念，否则无法和用户沟通。

- 这个级别的设计是给用户的上层领导看的，所以不用涉及很多业务细节，比如只需要知道有课程管理，而无需描述课程管理内部的具体细节。

- 通过讨论后，用户可能会提出新的需求，看看是不是能合并到已有的子系统中，如果不能，需要增加子系统。

#### 2. 逻辑功能架构

业务需求分析结束后，应该进入技术阶段了，根据需求分析的用户需求和功能需求建立软件系统的静态模型。如 R-逻辑视图、U-结构模型、C-容器、T-应用架构、O-逻辑架构。这张图是给开发团队的所有人（但主要是管理者）看的，可以掌控全局，所以应该是分层、分模块的软件功能静态模型，可以叫做**逻辑功能架构**。见图 13.4.3。

<img src="img/Slide17.SVG"/>

图 13.4.3 逻辑功能架构图

【最佳实践】

如果把业务场景架构看作是俯视图，那么逻辑架构就是一个横向的切片，类似医学上 CT。比如，在图 13.4.3 中，在表示层、应用层、数据访问层，都会出现“生活（服务）”，这是一种技术上的划分，三个层次的模块串联在一起共同实现“生活服务”子系统。

与图 13.4.2 比较，本图的关注点在于：

- 软件功能子系统/模块的划分。那么“生活服务”中的“食堂管理”、“宿舍管理”要不要列出来呢？在这个阶段中不需要列出来，而是在做生活服务子系统的概要设计时再考虑。

- 公共业务下沉（比如单点登录），因为这是所有子系统必须都调用的业务。

- 在 7.4 节中我们讲过三种层次的需求：业务需求，用户需求，功能需求。在本图中要发掘出功能需求，如“管理员子系统”，这是用户自己想不到的，只能由系统设计人员提出。

- 大的架构单元之间的相互关系要绘制出来，而不必关心具体的调用关系或者接口协议，只是表达“A 和 B 有联系”即可。


#### 3. 应用运行架构

既然有了静态模型，还应该有动态模型来描述系统内部的交互行为已经状态变化，如 R-过程视图、U-行为模型、C-组件图、T-应用架构、O-运行架构。通过这个模型，可以知道软件系统在运行过程中的内部具体流程，用于分析性能质量问题，可以叫做**应用运行架构**。见图 13.4.4。

<img src="img/Slide18.SVG"/>

图 13.4.4 应用运行架构图

运行架构的目的是 —— 确定控制流和控制流的组织；

　　　　　其中控制流包括 —— 进程、线程、服务程序；

　　　　　控制流组织包括系统的启动与停机、控制流通讯、同步与加锁。

#### 4. 软件开发架构

按照软件工程，有了静态和动态设计后，就可以进行软件开发了，所以我们需要有**软件开发架构**来指导、统一开发者的行为。如 R-开发视图、U-实现模型、C-代码图、T-技术架构、O-开发架构，都是用于描述源代码组织方式、使用的框架组件、依赖关系等等。见图 13.4.5。

<img src="img/Slide19.SVG"/>

图 13.4.5 软件开发架构图

开发架构的目的是 —— 确定程序单元以及程序单元的组织结构；

　　　　　其中程序单元包括 —— 源文件、配置文件、程序库、框架、目标单元；

　　　　　程序单元组织包括project划分、project目录结构、编译依赖关系。

#### 5. 物理部署架构

开发完毕后才能进行产品部署，虽然是最后的动作，但是需要在第 2,3,4 步就有统一考虑，而不是等软件开发完毕后再想。这一部分叫做**物理部署架构**，主要是设计师根据系统非功能质量的要求做出的设计。如 R-物理视图、U-环境模型、T-技术架构、O-物理架构。见图 13.4.6。

<img src="img/Slide20.SVG"/>

图 13.4.6 物理部署架构图

技术选型
物理选型
分布设计
选型管理

物理架构的目的是 —— 确定物理节点和物理节点的拓扑结构；

　　　　　其中物理节点包括 —— 服务器、PC机、专用机、软件安装部署烧写以及系统软件的选型；

　　　　　拓扑结构明确物理节点的关系。


#### 6. 数据存储架构

最后这一部分不是必须的，如果是面向企业的数据密集型的软件系统才会用到，叫做**数据存储架构**，而一般的计算密集型软件中，在第 2,3 步中可以顺带给出，因为静态架构中可以有数据库的存在，在动态架构中，也离不开数据的读写过程。如 T-数据架构、O-数据架构。见图 13.4.7。

<img src="img/Slide21.SVG"/>

图 13.4.7 数据存储架构图


数据架构的目的是 —— 确定要存储的数据以及存储格式；

　　　　　其中存储的数据可以是文件、关系数据库、实时数据库；

　　　　　存储格式包括文件格式、数据库图表。

数据类型/来源

数据模型

数据存储/分布

数据流

数据管理


数据（持久化）架构：对存储数据（资源）的架构方法论，其架构原则同应用架构大同小异，即考虑到各个系统应用场景、不同时间段的应用场景对数据进行诸如数据异构、读写分离、数据库或NOSQL的策略、缓存的使用、分布式数据（数据库）策略等等。 数据架构主要解决三个问题：

1. 系统需要什么样的数据；
2. 如何存储这些数据；
3. 它们之间的联系是什么。

### 13.4.2 设计难度进化

把上述步骤总结为表 13.4.1，形成**六视图法**。注意该表中各方法的顺序与图 13.4.1 有所不同，主要是为了横向比较，不会影响架构设计工作的进行。

表 13.4.1 架构设计方法的统一

|顺序|统一名称|RUP 4+1|UML|C4|TOGAF|Other|
|-|-|-|-|-|-|-|-|
|1|**业务场景架构**|场景视图|用户模型|上下文图|业务架构|N/A|
|2|**逻辑功能架构**|逻辑视图|结构模型|容器图|应用架构|逻辑架构|
|3|**应用运行架构**|过程视图|行为模型|组件图|应用架构|运行架构|
|4|**软件开发架构**|开发视图|实现模型|代码图|技术架构|开发架构|
|5|**物理部署架构**|物理视图|环境模型|N/A|技术架构|物理架构|
|6|**数据存储架构**|N/A|N/A|N/A|数据架构|数据架构|

从表 13.4.1 中可看到：

- 最左侧的序号表明了架构任务的顺序，按照这个顺序进行是最合理的。
- 第二列中使用 6 个字的统一名称，这样命名更加准确，以避免一些模糊的含义产生错误的理解。
- TOGAF 的应用架构和技术架构都出现了两次，正如 13.3.4 节中所说，因为这个方法不是标准的软件工程方法，所以它的定义比较模糊。目前在业界有很多人使用这个方法，在网上查资料看到的画出来的图关注点混乱不堪，误导读者，慎用。
- C4 模型是一种轻量级的设计方法，其实就是像看电子地图一样一步步放大，直到能看到代码细节。适合于小型系统做概要设计。

### 13.4.2 简易方法

【最佳实践：**两视图法**】

有些比较小的系统很难把上述架构图都画出来，可以只有“**业务架构 + 技术架构**”，其中，业务架构就是业务场景架构，技术架构的定义如下：

$$
技术架构 = 逻辑功能 + 应用运行 + 数据存储 + 软件开发 + 物理部署
$$

说白了就是把 2,3,4,5,6 混在一起画。在第十二章中讲技术架构演化的故事时，基本上就是采用了这种办法。

【最佳实践：**三视图法**】

如果对物理部署架构的要求较高，也可以把它从技术架构中拆出来，最后形成三张图：“**业务架构 + 软件架构 + 硬件架构**”。其中，业务架构就是业务场景架构，硬件架构就是物理部署架构，软件架构的定义如下：

$$
软件架构 = 逻辑功能 + 应用运行 + 数据存储 + 软件开发 
$$

