
## 14.8 第六步：状态设计

在数据流图中定义了一系列大的流程，在功能设计中划分了模块，但是都没有给出所有的分支和细节，所以我们在这一小节要通过对控制中心的状态转换设计来捋清楚所有细节。绘制传统的流程图也是可以做到这一点的，但是不包含状态名称信息，在后面的文档或者开发过程中，不容易形成共同语言。而且使用流程图做设计，实现时只能用 if...else 来编写代码，当一个对象状态非常复杂时，用 if...else 解决不了问题。

### 14.8.1 虚拟机状态设计

由于系统都运行在 Azure 上，而且定制化程度较高，所以我们都使用 Azure 上的虚拟机来搭建控制中心、训练子系统、推理子系统。

由于虚拟机的收费较高，所以要研究清楚虚拟机的收费策略，即：
- 需要申请虚拟机，虚拟机自动启动；
- 虚拟机在“已启动”时，是按时长收费的，不管是否运行了应用程序；
- 虚拟机在“已关闭”时，仍然收费（Azure的这个设计让用户有些不解，并因此忘记释放资源而继续被动付费）；
- 虚拟机在“已释放”后，停止收费，但是“释放”并非“删除”，里面安装的应用和数据还是可以打开虚拟机后再重新加载继续使用的，不会丢失；
- 虚拟机在删除后，数据全部丢失。

把上面的策略总结成状态转换，如图 14.8.1 所示。

<img src="img/Slide19.SVG"/>

图 14.8.1 虚拟机状态设计

左侧表格为状态转移表，分成三部分：

- 左边栏：出发的状态，如“启动中”。
- 上边拦：到达的状态，如“已启动”。
- 中间方格：经历的动作或过程，如“启动完毕”

该表格与右侧上方的图的描述是一致的，在状态较少时，可以用表格描述；而当状态较多时，用图描述。图中的各个元素图例如表 14.8.1 所示。

表 14.8.1 状态机图例

|元素|图例|说明|
|-|-|-|
|起点（Start）|圆点|表示初始状态，全图中只有一个|
|终点（End）|带圈圆点|表示终止状态，全图中只有一个|
|状态（State）|圆角矩形|中间状态，如“启动中”|
|动作（Action）|有方向和文字的线|方向表示转移方向，文字表示动作内容，如“关闭电源”|

### 14.8.2 错误的状态设计

初学者在做状态设计的时候，会出现的一些常见错误如图 14.8.1 右侧下图所示。

同样是虚拟机的状态设计，存在三个问题：

1. 状态域不正确
   
   我们可以对比上图，就可以发现问题：本图中“启动中”和“已关闭”状态是正确的虚拟机状态域，都是属于硬件和操作系统级别的状态；但是“空闲”和“繁忙”并不是，它们是属于应用软件系统的状态。

2. 状态/事件缺失
   
   和上一个状态域不正确的问题合并，缺失“已启动”、“关闭中”两个状态，实际上“空闲”应该是“已启动”，“繁忙”应该是“关闭中”。因为关闭不是瞬间完成的，如果可以瞬间完成的话，那么事件应该是“掉电”。

3. 状态跳跃不正确

   我们先假设“繁忙”是正确的状态，从“繁忙”跳到“已关闭”的话，会有很多应用数据丢失，所以必须从“繁忙”先跳到“空闲”，把正在执行的任务优雅地停止，保存好状态数据，然后才能关闭。

【最佳实践】在状态设计中常见的错误就是丢失状态，因为有些状态不是一蹴而就的，需要一个渐变的过程，这就需要有中间状态来做过渡。

### 14.8.3 控制中心的状态设计

<img src="img/Slide18.SVG"/>

图 14.8.2 控制中心状态设计

在图 14.8.2 中，我们给出了两组控制中心的状态，左侧是平时只做推理时的状态转换，我们在前面已经讲述过了，不再重复。右侧是需要训练新模型时的状态转换，解释如下：

1. 初始状态，手工启动控制中心的程序，进入“已启动”状态；
2. 用户上传数据，完毕后会通知控制中心，进入“已上传”状态；
3. 自动检测数据，如果合格，就启动训练，进入“训练中”状态；如果不合格，就终止；
4. 训练完毕后进入“已训练”状态；
5. 检查训练结果，即新的数据模型是否优于旧的模型，合格的话使用新模型进入推理，不合格的话使用旧模型进入推理；进入“推理中”状态；
6. 推理完毕，进入“已推理”状态；
7. 检查推理结果，如合格就发布结果，进入“已发布”状态；如果不合格，就“终止”；
8. 发布完毕后，进入“终止”状态。

其中，“启动控制中心”和“退出控制中心”都是手动完成的，不需要编码。

