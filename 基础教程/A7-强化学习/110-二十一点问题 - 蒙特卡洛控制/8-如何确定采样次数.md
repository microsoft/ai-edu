
## 采样


###

直接采样
每次访问
首次访问
重要性采样
接受拒绝

### 如何确定采样的次数

<center>
<img src="./img/Sampling-RMSE.png">

图 2
</center>



具体地说就是如何确定算法中的幕数 Episodes 的数值。

根据问题的复杂程度不同，幕数必然会不同。但到目前为止，没有人从理论层面研究过这个问题，所以有一些偏实践的方法，供大家参考。

#### 试探

先用比较小的数值，比如 100，去做几次尝试，如果发现几次尝试的结果之间有很大的方差，就增加到 1000 再试试 ...... 以此类推，也许到 10 万时才能相对稳定。

方差公式为：

$$
\sigma^2=\frac{1}{n}\sum_{i=1}^n (V_i-\mu)^2 \tag{2}
$$

比如，我们只关注 Rest 状态的价值函数值，运行 3 次得到 $V_1,V_2,V_3$ 的值，而 $\mu=\frac{1}{3}(V_1+V_2+V_3)$ 是均值：

1. 当 episodes=100 时，运行 3 次，结果分别是 [1.2, 2.8, 2.0]，相差非常大，$\sigma^2=0.427$；
2. 设置 episodes=1000，运行 3 次，结果分别是 [0.5, 1.2, 0.9]，方差减小了，$\sigma^2=0.082$，但还不够好；
3. 设置 episodes=10000，运行 3 次，结果分别是 [0.86, 0.75, 0.82]，$\sigma^2=0.002$，如果这个方差到了你的心理预期，就可以结束了，否则可以再增加 episodes 的次数。

#### 比较

先看一个增量计算平均值的公式：

$$
\begin{aligned}
V_{n+1} &= \frac{1}{n+1} \sum_{i=1}^{n+1} G_i=\frac{1}{n+1}(\sum_{i=1}^{n} G_i+G_{n+1})
\\\\
&= \frac{1}{n+1}(G_{n+1}+nV_n)= \frac{1}{n+1}(G_{n+1}+n V_n+ V_n-V_n)
\\\\
&=V_n + \frac{1}{n+1}(G_{n+1}-V_n)
\end{aligned}
\tag{3}
$$

式 3 表达的意思是，n+1 幕时 $G_{n+1}$ 的期望值 $V_{n+1}$，等于 $n$ 幕时的 $G_n$ 期望值 $V_{n}$，再加上 n+1 幕时的 $G_{n+1}$ 与 $V_n$ 的差值除以 (n+1)。

把式 3 变形得到：

$$
V_{n+1} - V_{n} = \frac{1}{n+1}(G_{n+1}-V_n)
\tag{4}
$$


在第 n+1 幕时，先计算出式 4 的等号后面的部分，检查这个值是否足够小（比如小于 1e-2），就可以认为已经收敛了。当然，这里的步长可以不是 1 幕，而是 10 幕或者 100 幕才会做一次检查。

### 问题与讨论

1. 请使用试探法来找到比较理想的分幕次数。
2. 请使用比较法来找到比较理想的分幕次数。
