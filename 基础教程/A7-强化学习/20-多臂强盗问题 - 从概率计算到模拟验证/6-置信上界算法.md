## 2.6 置信上界法（UCB）

UCB - Upper Confidence Bound，置信上界。

### 2.6.1 置信度和置信区间

#### 点估计

一个中学有 2000 名学生，体育老师想知道男生女生的平均身高。如果都测量一遍，工作量太大，所以体育老师就只在每个年级中抽测一个班的学生的身高，用于估计全校学生的平均身高。

#### 区间估计

在抽测之前，几个体育老师先给出了自己的“盲猜”。老师甲说：我估计男生的平均身高是 1.75 米，女生是 1.65 米。老师乙说：我估计男生的平均身高在 1.73 米到 1.77 米，女生是 1.62 米到 1.66 米之间。老师丙说：我估计男生在 1 米到 2 米之间，女生也一样......其它老师一阵哄笑......

#### 置信度（置信水平）与置信区间

置信度（confidence coefficient）

- 老师甲的估计数据过于精确，但是不容易正确。
- 老师丙说的虽然是个笑话，但是它的准确程度基本上可以达到 100%。
- 老师乙估计得更“靠谱”一些，也就是说有 95% 的把握是正确的，这个 95% 就是置信度，[1.73,1.77] 以及 [1.62,1.66] 就是置信区间。

#### 计算置信区间



1. 测量一个班的学生的身高，叫做采样，得到样本（每个学生的身高值）。
2. 计算平均值：$\mu=\frac{1}{n} \sum_i h_i$，$h_i$ 表示每个学生的身高，$n$ 是学生数量，假设 $n=100, \mu=170(cm)$。
3. 计算标准差：$\sigma=\sqrt{ \sum (h_i-\mu)^2/n}$，假设 $\sigma=3$。
4. 计算标准误差：$SE = \frac{\sigma}{\sqrt{n}}=\frac{0.3}{\sqrt{100}}=0.3$。
5. 确定置信度，即“把握”有多大。比如是 90% 呢还是 95%？假设我们确定为 90%。
6. 计算 90% 对应的概率，$p=(1-0.9)/2=0.05$，即左右都允许 0.05 的误差。
7. 用 0.05 查 Z 表，得到 $Z=\pm 1.64$，即均值两侧各有 1.64 个标准差。
8. 计算置信区间：左侧边界 $a=170-1.64 \cdot 0.3=169.5$，右侧边界 $b=170+1.64 \cdot 0.3=170.5$，则置信区间为 $[169.5, 170.5]$。

一般来说，直接指定置信度就可以了，比如 95%，而不需要计算出具体数值。


### 2.6.2 霍夫丁不等式


若 $[X_1,\cdots,X_n]$ 为 [0,1] 之间的随机变量，其均值为 $\bar{X} = \frac{1}{n}(X_1+\cdots+X_n)$，则根据霍夫丁不等式有：

$$
\mathbb P\big[\bar{X} - \mathbb E [X] > \epsilon \big ] \le e^{-2n\epsilon^2}
\tag{2.6.1}
$$

意为 X 的平均数与真实均值的差大于误差 $\epsilon$ 的概率为 $e^{-2n\epsilon^2}$。

可以与真实应用场景对接：

- $\mathbb E[X]$，样本期望值，可以看作某个动作的真实价值 $Q(a)$；
- $\bar{X}$，样本均值，可以看作根据历史记录估算出来的某个动作的价值 $\hat{Q}(a)$；
- $n$，样本数量，可以看作选择某个动作的次数 $N(a)$；
- $\epsilon$，任意正数，一般表示误差，可以看作某个动作的价值上界 $U(a)$。

式（2.6.1）可以改写为：

$$
\mathbb P[\hat{Q}(a) - Q(a) > U(a)] \le e^{-2N(a)U(a)^2} \tag{2.6.2}
$$

从数学符号层面令 $p=e^{-2N(a)U(a)^2}$，对式（2.6.2）两边取自然对数运算，得到关于上界 $U(a)$ 的表达式：

$$
U(a) = \sqrt{\frac{-\ln p}{2N(a)}}
$$

因为 $\epsilon$ 可以是任何正数，所以接下来我们赋予 $p$ 一个真实的含义，指定 $p = t^{-2}$，$t$ 为赌博机迭代次数，一般都很大，$p$ 就会很小，则：

$$
U(a) = \sqrt{\frac{-\ln p}{2N(a)}}=\sqrt{\frac{\ln t}{N(a)}}
\tag{2.6.3}
$$


$$
A_t = \argmax_a \Big [Q_t(a) + c\sqrt{\frac{\ln t}{N_t(a)}} \Big ]
$$

由于操作符是 $\argmax_a$，所以后面的表达式中的 $a$ 都是指的动作集中的每个动作都做一次计算，然后取出最大值。

- $A_t$：最终选出的最佳动作。
- $Q_t(a)$：每个动作的价值估算。
- $c$：参数。
- $\ln t$：$t$ 为迭代次数，求其自然对数值。
- $N_t(a)$：每个动作被选择的次数，小于迭代次数 $t$。


