
## 8.1 射击气球问题



### 8.1.1 提出问题

在游乐场，有一个（用弓箭）射击气球中奖的游戏规则如图 8.1.1 所示，是这样的：

<center>
<img src="./img/shoot-1.png">

图 8.1.1 射击气球游戏
</center>

1. 游客花 4 元钱买 2 支箭，得到两次射击机会；
2. 墙上有两个气球，一个蓝色大气球，一个红色小气球，每次射击游客可以任意选择目标；
3. 脱靶不得奖；
4. 击破蓝色大气球可以得到小奖，价值 1 元；
5. 击破红色小气球可以得到大奖，价值 3 元。

游乐场老板经过几个月的营业后进行了统计，当然老板的目的不是做人工智能学习，而是要看能否多赚钱。结果如图 8.1.2 所示。

<center>
<img src="./img/shoot-2.png">

图 8.1.2 游客中奖情况统计
</center>

统计结果说明：

1. 游客在第一次射击时：

    - 中大奖的概率是 0.06
    - 中小奖的概率是 0.38
    - 脱靶的概率是 0.56


2. 第二次射击根据第一次射击的结果而有所不同：

    比如，如果第一次射击中大奖，则：
    - 第二次射击继续中大奖的概率会是 0.10，比初始的 0.06 提高了一些，因为游客有经验了；
    - 第二次射击脱靶的概率是 0.40，比初始的 0.56 要低；
    - 第二次射击中小奖的概率是 0.50，比第一次的 0.38 要高，也是因为有了一定的经验而提高了命中率。
    
    其它统计数字在图 2 中显示，不再赘述。

### 8.1.2 错误的 MRP 模型

老板设计的这个游戏很精明，因为游客会从数字中得到暗示：如果我中一个大奖和一个小奖，正好 4 元钱，抵掉了两支箭的花销。但实际上的中奖概率很低。那么做为一个聪明的游客，你应该如何选择呢？

在前面的章节中，我们学习过马尔科夫奖励过程的知识，是否可以把图 8.1.2 转换成状态转移矩阵与奖励函数，用来计算“脱靶、小奖、大奖” 三个状态的哪一个的状态价值函数值最大，来判断选择哪种方案呢？

有些读者前面的学习基础很牢固，于是可以立刻画出如图 8.1.3 的状态转移图和转移概率表。

<center>
<img src="./img/shoot-3.png">

图 8.1.3 MRP 模型下的状态转移图
</center>

然后在前面的代码的基础上换一下数据（状态、转移、奖励），即可用矩阵法立刻解出结果。

我们可以先检查一下这个状态转移矩阵的收敛情况：

【代码位置】Shoot_0_MPR_Wrong.py

```
折扣 = 1
迭代100次, 检查状态转移矩阵是否趋近于 0: 
[[0.    0.524 0.405 0.071]
 [0.    0.524 0.405 0.071]
 [0.    0.524 0.405 0.071]
 [0.    0.524 0.405 0.071]]
------------
价值函数：
Start:  6174930.04
Miss:   6174934.04
Small:  6174935.15
Grand:  6174937.304
```

当折扣值 $\gamma=1$ 时，这个转移矩阵本身收敛到了 [0, 0.524, 0.405, 0.071]，意味着如果游客持续地射击多次，脱靶的可能性最大（0.524），中小奖的可能性为 0.405，中大奖的可能性为 0.071。

从输出的价值函数值看，值都很大。因为可以在多个状态之间不断地循环，获得很多很多奖励。但是却忽略了一个条件：每个游客只能射箭两次。如果要多次射箭的话，需要停下来买更多的箭。从图 8.1.3 左图来看，“开始”状态只经历了一次，所以这个状态转移图画得不对。

另外，没有收敛到全 0 状态，说明用迭代法计算状态价值函数是有问题的，会有无限奖励。因此需要折扣值小于 1。

下面我们看看 $\gamma=0.9$ 时的情况：
```
折扣 = 0.9
迭代100次, 检查状态转移矩阵是否趋近于 0:
[[0. 0. 0. 0.]
 [0. 0. 0. 0.]
 [0. 0. 0. 0.]
 [0. 0. 0. 0.]]
------------
价值函数：
Start:  1.501
Miss:   5.501
Small:  6.599
Grand:  8.736
------------
```
这次的转移矩阵趋近于 0 了，说明迭代可以收敛，价值函数基本反映出了各个状态的比较结果。但还是存在前面说过的问题：在后面的状态转移中，没有包括前面的“开始”状态，相当于忘记了最开始要花 4 元钱买箭的问题，这就应了那句话：“只看见贼吃肉，没看见贼挨打”。所以整个的状态价值函数计算模型就是错误的。

### 8.1.3 正确的 MRP 模型

这个问题的状态转移图应该如图 8.1.4 所示，是一个有向无环图。

<center>
<img src="./img/shoot-4.png">

图 8.1.4 正确的的状态转移图
</center>

图例说明：

- 圆圈内的文字是状态描述，数值是该状态的序号。
- 连线是状态转移方向，数值是状态转移概率。
- 红色的 $R$ 是奖励值。
- 方框是终止状态 T。

状态说明：

1. 虽然状态中有四个“大奖”，四个“小奖”，四个“脱靶”，但是这四个状态不是同一个状态，只是名字一样而已，在图中特意用序号把它们都区分开了。其中：
    - 0 号为开始状态；
    - 1~3 号为二级状态；
    - 4~12 号为三级状态。
2. 开始状态需要有 -4 的奖励，因为一开始游客是花 4 元钱买了两支箭。
3. 所有的三级状态（序号4~12），最后都接一个终止状态 T，在第二次射击后，都会以 1 的概率达到该状态。
4. 奖励是定义在状态上的，面向结果，在绘图时故意让字母 $R$ 与状态区域重合，以强调这一点。

为什么状态中含有四个“大奖”不能只用一个状态来表示呢？换句话说，为什么图 8.1.3 是错误的呢？

就好比从一楼上 10 级台阶到二楼，台阶可以定义为 $S_{1,1}$ 到 $S_{1,10}$；而二楼到三楼同样有 10 级台阶，也定义为 $S_{2,1}$ 到 $S_{2,10}$。但所处的楼层不一样，所以它们也是 20 个不同的状态。假设除了楼梯以外，还有一个滑梯，从 $S_{2,1}$ 能直接滑到 $S_{1,1}$，从而造成环，那就是两个状态之间的循环转移，在本例中并不存在。

### 8.1.4 计算 MRP 模型的状态价值函数

由于是个有向无环的图，所以可以简单地从后向前计算一下各个状态的价值函数。根据式 xxx 很简单就可以得到（为简化计算过程，本例中折扣 $\gamma=1$）：

首先，终止状态 $v_T = 0$。

然后以 $v_4$ 为例应用式 ()：$v_4 =R(s)+ \gamma P_{ss'}V(s')= 3+1\times1\times0=3$。其它三级状态的计算方法相同，得到三级状态的值后，就可以向上继续计算二级状态的价值函数，最后得到开始状态的价值函数。

$$
\begin{cases}
v_T=0 & (终止状态)
\\
v_4=0, v_5 = 1, v_6 = 3 &(三级状态)
\\
v_7=0, v_8=1, v_9=3 &(三级状态)
\\
v_{10}=0, v_{11}=1, v_{12}=3 &(三级状态)
\\
v_1 = 0 + 0.56v_4+0.38v_5+0.06v_6= 0.56&(二级状态)
\\
v_2 = 1 + 0.50v_7+0.42v_8+0.08v_9= 1.66&(二级状态)
\\
v_3 = 3 + 0.40v_{10}+0.50v_{11}+0.10v_{12}= 3.8&(二级状态)
\\
v_0 = -4 + 0.56v_1+0.38v_2+0.06v_3 = -2.8276 &(开始状态)
\end{cases}
$$

当然，也可以用矩阵法来解这个线性方程组，得到的结果和手工计算的一致：

【代码位置】Shoot_1_MPR_Correct.py
```
v0 = -2.8276
v1=0.56,        v2=1.66,        v3=3.8
v4=0.0,         v5=1.0,         v6=3.0
v7=0.0,         v8=1.0,         v9=3.0
v10=0.0,        v11=1.0,        v12=3.0
```

最终的状态价值函数结果标在图 8.1.5 中，圆圈内的数值是马尔可夫奖励过程的状态价值函数值。

<center>
<img src="./img/shoot-5.png">

图 8.1.5 MRP 模型的状态价值函数值
</center>

所以，从统计学的观点看，$s_0$ 的状态函数值 $v_0$ 告诉我们只要游客买了箭，就已经亏了，老板是稳赚不赔的。当然不排除个别游客（射箭能手）连续两次击中大奖。一般人都会高估自己（哈哈，科学的说法是：不能正确地评估自己），一些游客会因为想到最大值为 3+3=6 的奖励而参与，一些游客只是因为没有射过箭而参与。

那么游客应该怎么选择呢？

- 虽然 $v_{3}=3.8$ 状态价值最高，但是到达 $s_3$ 只有 0.06 的概率，可以理解为游客的预期收益是：$0.06 \times 3.8 = 0.228$ 元。
- $s_1$ 的预期收益是 $0.56 \times 0.56 = 0.3136$ 元。
- $s_2$ 的预期收益是 $0.38 \times 1.66 = 0.6308$ 元。

上面三个状态的预期收入值相加为 1.1724 元，正好等于游客开始花的 4 元再加上 $v_0$ 的值，即 4-2.8276=1.1724，这也是 $v_0$ 的表达式告诉我们的。


所以游客第一次射击时应该选择 $s_2$，即“小奖”状态，然后第二次射击时继续选择“小奖”状态。这样虽然肯定不能赢回开始花的 4 元钱，但是可以做到损失最小（或者收益最大）。
